name: Docker Build & Publish

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Extract metadata for Combined image
        id: meta-combined
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          build-args: |
            BUILD_SHA=${{ github.sha }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Combined image using multi-stage Dockerfile
      - name: Create combined Dockerfile
        run: |
          cat > Dockerfile.combined << 'EOF'
          # Combined ChurnVision Docker Image
          # This image runs both backend and frontend for easy deployment

          FROM python:3.11-slim as backend-builder

          WORKDIR /app

          RUN apt-get update && apt-get install -y \
              build-essential \
              curl \
              libpq-dev \
              && rm -rf /var/lib/apt/lists/*

          RUN pip install uv

          COPY backend/pyproject.toml backend/README.md ./
          COPY backend/app ./app
          COPY backend/alembic ./alembic
          COPY backend/alembic.ini .

          RUN uv pip install --system .

          # Frontend build stage
          FROM oven/bun:latest as frontend-builder

          WORKDIR /app

          COPY frontend/package.json frontend/bun.lock* ./
          RUN bun install --frozen-lockfile

          COPY frontend/ ./
          RUN bun run build

          # Final stage
          FROM python:3.11-slim

          ARG BUILD_SHA=dev
          ARG BUILD_DATE=unknown

          ENV BUILD_SHA=${BUILD_SHA}
          ENV BUILD_DATE=${BUILD_DATE}

          WORKDIR /app

          RUN apt-get update && apt-get install -y \
              libpq-dev \
              nginx \
              supervisor \
              && rm -rf /var/lib/apt/lists/*

          # Create non-root user
          RUN groupadd --gid 1000 appgroup && \
              useradd --uid 1000 --gid appgroup --shell /bin/bash --create-home appuser

          # Copy backend from builder
          COPY --from=backend-builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
          COPY --from=backend-builder /app /app

          # Copy frontend build
          COPY --from=frontend-builder /app/dist /var/www/html

          # Copy entrypoint
          COPY backend/entrypoint.sh /entrypoint.sh
          RUN chmod +x /entrypoint.sh

          # Nginx config for SPA
          RUN echo 'server { \
              listen 3000; \
              root /var/www/html; \
              index index.html; \
              location /api { \
                  proxy_pass http://127.0.0.1:8000; \
                  proxy_http_version 1.1; \
                  proxy_set_header Host $host; \
                  proxy_set_header X-Real-IP $remote_addr; \
              } \
              location / { \
                  try_files $uri $uri/ /index.html; \
              } \
          }' > /etc/nginx/sites-available/default

          # Supervisor config
          RUN echo '[supervisord] \n\
          nodaemon=true \n\
          \n\
          [program:backend] \n\
          command=/entrypoint.sh \n\
          directory=/app \n\
          autostart=true \n\
          autorestart=true \n\
          stdout_logfile=/dev/stdout \n\
          stdout_logfile_maxbytes=0 \n\
          stderr_logfile=/dev/stderr \n\
          stderr_logfile_maxbytes=0 \n\
          \n\
          [program:nginx] \n\
          command=/usr/sbin/nginx -g "daemon off;" \n\
          autostart=true \n\
          autorestart=true \n\
          stdout_logfile=/dev/stdout \n\
          stdout_logfile_maxbytes=0 \n\
          stderr_logfile=/dev/stderr \n\
          stderr_logfile_maxbytes=0' > /etc/supervisor/conf.d/churnvision.conf

          # Create directories
          RUN mkdir -p /app/logs /app/models /app/churnvision_data && \
              chown -R appuser:appgroup /app /var/www/html /var/log/nginx /var/lib/nginx /run

          EXPOSE 3000

          CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/supervisord.conf"]
          EOF

      - name: Build and push Combined image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.combined
          push: true
          tags: ${{ steps.meta-combined.outputs.tags }}
          labels: ${{ steps.meta-combined.outputs.labels }}
          build-args: |
            BUILD_SHA=${{ github.sha }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
