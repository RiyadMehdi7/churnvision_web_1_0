# ChurnVision Enterprise - Database Docker Compose Configuration
# This file defines the PostgreSQL database setup for development and production

version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: churnvision_db
    restart: unless-stopped

    environment:
      # Database credentials (override in .env file)
      POSTGRES_DB: ${POSTGRES_DB:-churnvision}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}

      # PostgreSQL configuration
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8"

      # Performance tuning
      POSTGRES_SHARED_BUFFERS: ${POSTGRES_SHARED_BUFFERS:-256MB}
      POSTGRES_EFFECTIVE_CACHE_SIZE: ${POSTGRES_EFFECTIVE_CACHE_SIZE:-1GB}
      POSTGRES_MAX_CONNECTIONS: ${POSTGRES_MAX_CONNECTIONS:-100}
      POSTGRES_WORK_MEM: ${POSTGRES_WORK_MEM:-4MB}
      POSTGRES_MAINTENANCE_WORK_MEM: ${POSTGRES_MAINTENANCE_WORK_MEM:-64MB}

    ports:
      - "${POSTGRES_PORT:-5432}:5432"

    volumes:
      # Persistent data storage
      - postgres_data:/var/lib/postgresql/data

      # Initialization scripts (run on first startup)
      - ./init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro

      # Custom PostgreSQL configuration
      - ./postgresql.conf:/etc/postgresql/postgresql.conf:ro

      # Backup directory
      - ${BACKUP_DIR:-./backups}:/backups

      # Custom scripts
      - ./backup.sh:/usr/local/bin/backup.sh:ro
      - ./restore.sh:/usr/local/bin/restore.sh:ro
      - ./healthcheck.sh:/usr/local/bin/healthcheck.sh:ro

    command:
      - "postgres"
      - "-c"
      - "config_file=/etc/postgresql/postgresql.conf"

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-churnvision}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    networks:
      - churnvision_network

    labels:
      com.churnvision.service: "database"
      com.churnvision.environment: "${ENVIRONMENT:-development}"

  # pgAdmin (optional, for development only)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: churnvision_pgadmin
    restart: unless-stopped

    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@churnvision.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'

    ports:
      - "${PGADMIN_PORT:-5050}:80"

    volumes:
      - pgadmin_data:/var/lib/pgadmin
      - ./pgadmin-servers.json:/pgadmin4/servers.json:ro

    depends_on:
      postgres:
        condition: service_healthy

    networks:
      - churnvision_network

    profiles:
      - development

    labels:
      com.churnvision.service: "pgadmin"
      com.churnvision.environment: "development"

  # Database backup service (runs periodic backups)
  db_backup:
    image: postgres:15-alpine
    container_name: churnvision_db_backup
    restart: unless-stopped

    environment:
      PGHOST: postgres
      PGPORT: 5432
      PGDATABASE: ${POSTGRES_DB:-churnvision}
      PGUSER: ${POSTGRES_USER:-postgres}
      PGPASSWORD: ${POSTGRES_PASSWORD:-changeme}
      BACKUP_DIR: /backups
      BACKUP_SCHEDULE: ${BACKUP_SCHEDULE:-0 2 * * *}  # Daily at 2 AM
      RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}

    volumes:
      - ${BACKUP_DIR:-./backups}:/backups
      - ./backup.sh:/usr/local/bin/backup.sh:ro

    command: >
      sh -c "apk add --no-cache dcron openssl &&
             echo '$${BACKUP_SCHEDULE} /usr/local/bin/backup.sh >> /var/log/backup.log 2>&1' | crontab - &&
             crond -f -l 2"

    depends_on:
      postgres:
        condition: service_healthy

    networks:
      - churnvision_network

    profiles:
      - production

    labels:
      com.churnvision.service: "backup"
      com.churnvision.environment: "${ENVIRONMENT:-production}"

volumes:
  postgres_data:
    driver: local
    name: churnvision_postgres_data
    labels:
      com.churnvision.data: "database"

  pgadmin_data:
    driver: local
    name: churnvision_pgadmin_data
    labels:
      com.churnvision.data: "pgadmin"

networks:
  churnvision_network:
    name: churnvision_network
    driver: bridge
    labels:
      com.churnvision.network: "main"
